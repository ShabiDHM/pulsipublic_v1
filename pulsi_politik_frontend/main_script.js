// pulsi_politik_frontend/main_script.js

// Initialization guard to prevent multiple executions
if (window.myAppInitialized) {
    console.warn("MAIN_SCRIPT.JS: Attempting to re-initialize. Aborting.");
} else {
    window.myAppInitialized = true;
    console.log("MAIN_SCRIPT.JS: Initializing for the first time.");

    // START: Initial Script Load Logging
    console.log("MAIN_SCRIPT.JS: Top of file reached, script is loading.");
    // END: Initial Script Load Logging

    window.onload = () => {
        // START: window.onload Startup Logging
        console.log("SCRIPT.JS: window.onload event fired. Startup initiated.");
        // END: window.onload Startup Logging

        // --- Define page identification variables early ---
        const getCurrentPageName = () => {
            const pathArray = window.location.pathname.split('/');
            const lastSegment = pathArray[pathArray.length - 1];
            const pageName = (lastSegment === '' || window.location.pathname.endsWith('/')) ? 'index.html' : lastSegment;
            return pageName;
        };
        const currentPageName = getCurrentPageName();
        const isDashboardPage = currentPageName === 'index.html';
        const isLocalGovPage = currentPageName === 'local_government.html';
        // --- End of early page identification ---

        let chartLibrariesLoaded = false;
        // START: Explicitly register ChartDataLabels plugin INSIDE window.onload
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            // Check if plugin is already registered to avoid errors
            if (Chart.registry.plugins.get('datalabels')) {
                console.log("SCRIPT.JS: ChartDataLabels plugin ALREADY registered.");
            } else {
                Chart.register(ChartDataLabels);
                console.log("SCRIPT.JS: ChartDataLabels plugin explicitly registered INSIDE window.onload.");
            }
            chartLibrariesLoaded = true;
        } else {
            console.warn("SCRIPT.JS: Chart or ChartDataLabels not defined at window.onload. Check CDN script loading. Chart-dependent features may fail.");
        }
        // END: Explicitly register ChartDataLabels plugin

        function initializeAppLogic() {
            console.log("SCRIPT.JS: initializeAppLogic() called.");
            console.log(`SCRIPT.JS (initializeAppLogic): Page ID: currentPage='${currentPageName}', isDashboard=${isDashboardPage}, isLocalGov=${isLocalGovPage}`);

            // START: Global Variables & Constants
            const API_BASE_URL = '/api'; // Logic updated to use MOCK DATA if this fails
            let currentPillar = 'Transparency';
            let currentLang = 'en';
            let allMinistriesData = [];
            let apiDataCache = { dashboard: {}, details: {} };
            let currentNotificationTimeout = null;
            let currentSortGlobal = 'score-desc';
            let ministryBarChart = null;
            let kosovoMapInstance = null;
            let selectedMunicipalityDataGlobal = null;
            // END: Global Variables & Constants

            // START: DOM Element References
            const languageSelectorButton = document.getElementById('languageSelector');
            const languageDropdown = document.getElementById('languageDropdown');
            const currentLanguageSpan = languageSelectorButton?.querySelector('span');
            const pillarTabs = isDashboardPage ? document.querySelectorAll('.tab-item') : null;
            let chartContainer = isDashboardPage ? document.getElementById('chart-container') : null;
            const currentViewTitle = isDashboardPage ? document.getElementById('currentView') : null;
            const ministryDetailsSection = isDashboardPage ? document.getElementById('ministryDetails') : null;
            const selectedMinistryNameTitle = isDashboardPage ? document.getElementById('selectedMinistryName') : null;
            const kpiElements = {};
            const detailElements = {};
            const perfBreakdownElements = {};
            const municipalityDetailsPanel = isLocalGovPage ? document.getElementById('selectedMunicipalityDetails') : null;
            const municipalityDetailsNameEl = isLocalGovPage ? document.getElementById('selectedMunicipalityName') : null;
            const municipalityCloseDetailsBtn = isLocalGovPage ? document.getElementById('closeMunicipalityDetailsButton') : null;
            const municipalityDetailTransparencyEl = isLocalGovPage ? document.getElementById('municipalityDetailTransparency') : null;
            const municipalityDetailTransparencyChangeEl = isLocalGovPage ? document.getElementById('municipalityDetailTransparencyChange') : null;
            const municipalityDetailRequestsEl = isLocalGovPage ? document.getElementById('municipalityDetailRequests') : null;
            const municipalityDetailRequestsProcessedEl = isLocalGovPage ? document.getElementById('municipalityDetailRequestsProcessed') : null;
            const municipalityDetailResponseTimeEl = isLocalGovPage ? document.getElementById('municipalityDetailResponseTime') : null;
            const municipalityDetailResponseTimeChangeEl = isLocalGovPage ? document.getElementById('municipalityDetailResponseTimeChange') : null;
            const municipalityRecentActivitiesBodyEl = isLocalGovPage ? document.getElementById('municipalityRecentActivitiesBody') : null;
            const municipalityPerfBreakdownElements = {};
            
            if (isLocalGovPage) { for (let i = 1; i <= 5; i++) { municipalityPerfBreakdownElements[`label${i}`] = document.getElementById(`municipalityPerfBreakdownLabel${i}`); municipalityPerfBreakdownElements[`value${i}`] = document.getElementById(`municipalityPerfBreakdownValue${i}`); municipalityPerfBreakdownElements[`bar${i}`] = document.getElementById(`municipalityPerfBreakdownBar${i}`); } }
            if (isDashboardPage) { Object.assign(kpiElements, { avgTransparencyValue: document.getElementById('kpiAvgTransparencyValue'), avgTransparencyChange: document.getElementById('kpiAvgTransparencyChange'), participationScoreValue: document.getElementById('kpiParticipationScoreValue'), participationScoreChange: document.getElementById('kpiParticipationScoreChange'), efficiencyRatingValue: document.getElementById('kpiEfficiencyRatingValue'), efficiencyRatingChange: document.getElementById('kpiEfficiencyRatingChange'), overallOutcomeValue: document.getElementById('kpiOverallOutcomeValue'), overallOutcomeChange: document.getElementById('kpiOverallOutcomeChange') }); Object.assign(detailElements, { transparencyScore: document.getElementById('detailTransparency'), transparencyChange: document.getElementById('detailTransparencyChange'), requests: document.getElementById('detailRequests'), requestsProcessed: document.getElementById('detailRequestsProcessed'), responseTime: document.getElementById('detailResponseTime'), responseTimeChange: document.getElementById('detailResponseTimeChange'), recentActivitiesBody: document.getElementById('recentActivitiesBody') }); for (let i = 1; i <= 5; i++) { perfBreakdownElements[`label${i}`] = document.getElementById(`perfBreakdownLabel${i}`); perfBreakdownElements[`value${i}`] = document.getElementById(`perfBreakdownValue${i}`); perfBreakdownElements[`bar${i}`] = document.getElementById(`perfBreakdownBar${i}`); } }
            // END: DOM Element References

            // START: Translations Object
            const translations = {
                en: { days: "days", headerTitle: "Public Pulse", headerSubtitle: "Kosovo Civic Monitor", languageEN: "English (EN)", languageSQ: "Albanian (SQ)", languageSR: "Serbian (SR)", currentLangIndicator: "EN", userMenuProfile: "Profile", userMenuSettings: "Settings", userMenuSignOut: "Sign out", sidebarMainNavigation: "MAIN NAVIGATION", sidebarDashboard: "Dashboard", sidebarDocuments: "Documents", sidebarEvents: "Events", sidebarAnalytics: "ANALYTICS", sidebarLocalGovernment: "Local Government", sidebarExportData: "Export Data", breadcrumbDashboard: "Dashboard", breadcrumbPublicPulse: "Public Pulse", breadcrumbDocuments: "Documents", breadcrumbEvents: "Events", breadcrumbLocalGovernment: "Local Government", breadcrumbExportData: "Export Data", breadcrumbAboutUs: "About Us", pageTitle: "Public Pulse Dashboard", pageSubtitle: "Monitoring transparency and performance of Kosovo institutions", kpiAvgTransparency: "Average Transparency", kpiParticipationScore: "Participation Score", kpiEfficiencyRating: "Efficiency Rating", kpiOverallOutcome: "Overall Outcome", kpiChangeSinceLastQuarter: "since last quarter", filtersTitle: "Interactive Filters", filtersReset: "Reset Filters", filtersExport: "Export", filtersTimePeriod: "Time Period", filtersCompareWith: "Compare With", filtersMinistryType: "Ministry Type", filtersScoreRange: "Score Range", filtersSearchMinistry: "Search Ministry", filtersSearchPlaceholder: "Type to search...", filtersApply: "Apply Filters", filtersShowComparison: "Show comparison", tabTransparency: "Transparency", tabParticipation: "Participation", tabEfficiency: "Efficiency", tabOutcome: "Outcome", viewTitleSuffix: "Scores", legendHigh: "High (>70)", legendMedium: "Medium (40-70)", legendLow: "Low (<40)", legendSortBy: "Sort by", sortHighestScore: "Highest Score", sortLowestScore: "Lowest Score", sortNameAZ: "Name (A-Z)", sortNameZA: "Name (Z-A)", detailsTitle: "Ministry Details", municipalityDetailsTitle: "Municipality Details", detailsTransparencyScore: "Transparency Score", detailsInfoRequests: "Information Requests", infoRequestsProcessed: "processed", detailsResponseTime: "Response Time", daysUnit: "days", detailsChangeSinceLastPeriod: "since last period", detailsPerfBreakdown: "Performance Breakdown", perfBreakdownWebsiteTransparency: "Website Transparency", perfBreakdownDocAccessibility: "Document Accessibility", perfBreakdownReqResponsiveness: "Request Responsiveness", perfBreakdownInfoCompleteness: "Information Completeness", perfBreakdownPublicEngagement: "Public Engagement", perfBreakdownDefaultLabel1: "Website Transparency", perfBreakdownDefaultLabel2: "Document Accessibility", perfBreakdownDefaultLabel3: "Request Responsiveness", perfBreakdownDefaultLabel4: "Information Completeness", perfBreakdownDefaultLabel5: "Public Engagement", detailsRecentActivities: "Recent Activities", tableHeaderDate: "Date", tableHeaderActivity: "Activity", tableHeaderStatus: "Status", tableStatusCompleted: "Completed", tableStatusInProgress: "In Progress", tableNoRecentActivities: "No recent activities to display.", tableNoDataToDisplay: "No data to display for the current filters.", notificationLangSwitchPrefix: "Language switched to", notificationFiltersApplied: "Filters applied", notificationFiltersReset: "Filters have been reset.", notificationComparisonEnabled: "Comparison view enabled", notificationComparisonDisabled: "Comparison view disabled", notificationExportingPrefix: "Exporting data as", notificationSortedByPrefix: "Sorted by", tooltipClickForDetails: "Click for details", tooltipScoreSuffix: "Score", categoryLabel: "Category", ministerLabel: "Minister", tooltipKeyMembers: "Key Members", optionNoComparison: "No Comparison", optionAllMinistries: "All Ministries", loadingData: "Loading data...", errorFetchingData: "Error fetching data. Using Mock Data.", noChangeData: "- No change data", categoryEconomic: "Economic", categoryGovernance: "Governance", categorySocial: "Social", categoryInfrastructure: "Infrastructure", categoryGeneral: "General", activityPrefixPublicEvent: "Public Event: ", activityPrefixReportRelease: "Report Release: ", activityPrefixNewInitiative: "New Initiative: ", activityPrefixConsultationDocument: "Consultation Document: ", periodQ2_2023: "Q2 2023", periodQ1_2023: "Q1 2023", periodQ4_2022: "Q4 2022", periodQ3_2022: "Q3 2022", periodAnnual_2022: "Annual 2022", periodQ1_2023_compare: "Q1 2023", periodQ4_2022_compare: "Q4 2022", periodQ2_2022_yoy: "Q2 2022 (YoY)", periodAnnual_2022_compare: "Annual 2022", dataNotAvailable: "N/A", mapPerformanceHigh: "High", mapPerformanceMedium: "Medium", mapPerformanceLow: "Low", mapScore: "Score", mapMayorLabel: "Mayor", mapCabinetMembersLabel: "Cabinet Members", mapPopulation: "Population", mapPerformance: "Performance", mapViewDetails: "View More Details", mapClickPrompt: "Click on a marker to see details."},
                // ... (Other languages SQ and SR would be here, abbreviated for brevity but keeping structure intact) ...
                 sq: { days: "ditë", headerTitle: "Pulsi Publik", headerSubtitle: "Monitoruesi Qytetar i Kosovës", kpiAvgTransparency: "Transparenca Mesatare", kpiParticipationScore: "Pikët e Pjesëmarrjes", kpiEfficiencyRating: "Vlerësimi i Efiçiencës", kpiOverallOutcome: "Rezultati i Përgjithshëm", kpiChangeSinceLastQuarter: "që nga tremujori i fundit", filtersTitle: "Filtrat Interaktivë", filtersReset: "Rivendos Filtrat", filtersExport: "Eksporto", filtersTimePeriod: "Periudha Kohore", filtersCompareWith: "Krahaso me", filtersMinistryType: "Lloji i Ministrisë", filtersScoreRange: "Diapazoni i Pikëve", filtersSearchMinistry: "Kërko Ministrinë", filtersSearchPlaceholder: "Shkruani për të kërkuar...", filtersApply: "Apliko Filtrat", filtersShowComparison: "Shfaq krahasimin", tabTransparency: "Transparenca", tabParticipation: "Pjesëmarrja", tabEfficiency: "Efiçienca", tabOutcome: "Rezultati", viewTitleSuffix: "Pikët", legendHigh: "Lartë (>70)", legendMedium: "Mesatare (40-70)", legendLow: "Ulët (<40)", legendSortBy: "Rendit sipas", sortHighestScore: "Pikët më të Larta", sortLowestScore: "Pikët më të Ulëta", sortNameAZ: "Emri (A-Z)", sortNameZA: "Emri (Z-A)", detailsTitle: "Detajet e Ministrisë", municipalityDetailsTitle: "Detajet e Komunës", detailsTransparencyScore: "Pikët e Transparencës", detailsInfoRequests: "Kërkesat për Informacion", infoRequestsProcessed: "të procesuara", detailsResponseTime: "Koha e Përgjigjes", daysUnit: "ditë", detailsChangeSinceLastPeriod: "që nga periudha e fundit", detailsPerfBreakdown: "Analiza e Performancës", perfBreakdownWebsiteTransparency: "Transparenca e Ueb-faqes", perfBreakdownDocAccessibility: "Qasshmëria e Dokumenteve", perfBreakdownReqResponsiveness: "Reagueshmëria ndaj Kërkesave", perfBreakdownInfoCompleteness: "Plotësia e Informacionit", perfBreakdownPublicEngagement: "Angazhimi Publik", perfBreakdownDefaultLabel1: "Transparenca e Ueb-faqes", perfBreakdownDefaultLabel2: "Qasshmëria e Dokumenteve", perfBreakdownDefaultLabel3: "Reagueshmëria ndaj Kërkesave", perfBreakdownDefaultLabel4: "Plotësia e Informacionit", perfBreakdownDefaultLabel5: "Angazhimi Publik", detailsRecentActivities: "Aktivitetet e Fundit", tableHeaderDate: "Data", tableHeaderActivity: "Aktiviteti", tableHeaderStatus: "Statusi", tableStatusCompleted: "Përfunduar", tableStatusInProgress: "Në Proces", tableNoRecentActivities: "Nuk ka aktivitete të fundit për të shfaqur.", tableNoDataToDisplay: "Nuk ka të dhëna për të shfaqur me filtrat aktualë.", notificationLangSwitchPrefix: "Gjuha u ndërrua në", notificationFiltersApplied: "Filtrat u aplikuan", notificationFiltersReset: "Filtrat janë rivendosur.", notificationComparisonEnabled: "Pamja e krahasimit u aktivizua", notificationComparisonDisabled: "Pamja e krahasimit u çaktivizua", notificationExportingPrefix: "Eksportimi i të dhënave si", notificationSortedByPrefix: "Renditur sipas", tooltipClickForDetails: "Klikoni për detaje", tooltipScoreSuffix: "Pikët", categoryLabel: "Kategoria", ministerLabel: "Ministri", tooltipKeyMembers: "Anëtarët Kyç", optionNoComparison: "Pa Krahasim", optionAllMinistries: "Të Gjitha Ministritë", loadingData: "Duke ngarkuar të dhënat...", errorFetchingData: "Gabim gjatë marrjes së të dhënave. Përdorimi i të Dhënave Mock.", noChangeData: "- Nuk ka të dhëna për ndryshim", categoryEconomic: "Ekonomike", categoryGovernance: "Qeverisjes", categorySocial: "Sociale", categoryInfrastructure: "Infrastrukturës", categoryGeneral: "Të Përgjithshme", activityPrefixPublicEvent: "Ngjarje Publike: ", activityPrefixReportRelease: "Publikim Raporti: ", activityPrefixNewInitiative: "Nismë e Re: ", activityPrefixConsultationDocument: "Dokument Konsultimi: ", periodQ2_2023: "TM2 2023", periodQ1_2023: "TM1 2023", periodQ4_2022: "TM4 2022", periodQ3_2022: "TM3 2022", periodAnnual_2022: "Vjetor 2022", periodQ1_2023_compare: "TM1 2023", periodQ4_2022_compare: "TM4 2022", periodQ2_2022_yoy: "TM2 2022 (VnM)", periodAnnual_2022_compare: "Vjetor 2022", dataNotAvailable: "E padisponueshme", mapPerformanceHigh: "E Lartë", mapPerformanceMedium: "Mesatare", mapPerformanceLow: "E Ulët", mapScore: "Pikët", mapMayorLabel: "Kryetari", mapCabinetMembersLabel: "Anëtarët e Kabinetit", mapPopulation: "Popullsia", mapPerformance: "Performanca", mapViewDetails: "Shiko Më Shumë Detaje", mapClickPrompt: "Klikoni mbi një shënues për të parë detajet." }
            };
            // END: Translations Object

            // START: CORE HELPER FUNCTIONS
            function getTranslation(key, lang = currentLang, fallbackLangOrText = 'en') { let text = translations[lang]?.[key]; if (text === undefined) { text = translations['en']?.[key]; } if (text === undefined) { text = (typeof fallbackLangOrText === 'string' && fallbackLangOrText !== 'en') ? fallbackLangOrText : key; } return text; }
            function capitalizeFirstLetter(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1) : ''; }
            function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
            function showNotification(msgKey, isKey = true) { const msg = isKey ? getTranslation(msgKey) : msgKey; const banner = document.getElementById('notificationBanner'); const notifMsg = document.getElementById('notificationMessage'); if (banner && notifMsg) { notifMsg.innerHTML = msg; banner.classList.remove('hidden'); if (currentNotificationTimeout) clearTimeout(currentNotificationTimeout); currentNotificationTimeout = setTimeout(() => banner.classList.add('hidden'), 3000); } }
            function showLoadingIndicator(isLoading) { if (isDashboardPage && chartContainer) { if (isLoading) { const canvas = chartContainer.querySelector('canvas#ministryScoreChart'); if (!canvas || !chartContainer.textContent.includes(getTranslation('loadingData'))) { chartContainer.innerHTML = `<p class="text-center p-4">${getTranslation('loadingData')}</p>`; } } } }
            // END: CORE HELPER FUNCTIONS

            // START: MOCK DATA GENERATORS (FIX FOR BROKEN BACKEND)
            const generateMockDashboardData = (pillar) => {
                const ministriesList = [
                    { id: 1, name: "Ministry of Finance", category_key: "economic", minister_name: "Hekuran Murati", score: 88.5, cabinet_members: ["Deputy A", "Advisor B"] },
                    { id: 2, name: "Ministry of Justice", category_key: "governance", minister_name: "Albulena Haxhiu", score: 72.3, cabinet_members: ["Deputy C", "Advisor D"] },
                    { id: 3, name: "Ministry of Health", category_key: "social", minister_name: "Arben Vitia", score: 65.8, cabinet_members: ["Deputy E", "Advisor F"] },
                    { id: 4, name: "Ministry of Environment", category_key: "infrastructure", minister_name: "Liburn Aliu", score: 55.2, cabinet_members: ["Deputy G", "Advisor H"] },
                    { id: 5, name: "Ministry of Culture", category_key: "social", minister_name: "Hajrulla Çeku", score: 81.0, cabinet_members: ["Deputy I", "Advisor J"] },
                    { id: 6, name: "Ministry of Education", category_key: "social", minister_name: "Arbërie Nagavci", score: 45.6, cabinet_members: ["Deputy K", "Advisor L"] },
                    { id: 7, name: "Ministry of Foreign Affairs", category_key: "governance", minister_name: "Donika Gërvalla", score: 68.9, cabinet_members: ["Deputy M", "Advisor N"] },
                    { id: 8, name: "Ministry of Defense", category_key: "governance", minister_name: "Ejup Maqedonci", score: 92.1, cabinet_members: ["Deputy O", "Advisor P"] }
                ];
                
                // Adjust scores slightly based on pillar to make it look dynamic
                ministriesList.forEach(m => {
                    if(pillar === 'Participation') m.score -= 10;
                    if(pillar === 'Efficiency') m.score += 5;
                    if(m.score > 100) m.score = 99;
                    if(m.score < 0) m.score = 5;
                });

                return {
                    kpi_summary: {
                        avgTransparency: { value: 71.5, change: 2.4 },
                        participationScore: { value: 58.2, change: -1.1 },
                        efficiencyRating: { value: 66.9, change: 0.8 },
                        overallOutcome: { value: 65.5, change: 1.5 }
                    },
                    ministries: ministriesList
                };
            };

            const generateMockMinistryDetails = (id, period) => {
                return {
                    profile: { id: id, name: `Ministry Mock Name ${id}` },
                    kpis: {
                        transparencyScore: { value: 75 + (Math.random() * 20 - 10), change: 1.5 },
                        infoRequests: { received: 120, processed: 110, percentage_processed: 91.6 },
                        responseTime: { value: 12, unit: 'days', change: -2 }
                    },
                    performanceBreakdown: [
                        { labelKey: "perfBreakdownWebsiteTransparency", value: 80 },
                        { labelKey: "perfBreakdownDocAccessibility", value: 65 },
                        { labelKey: "perfBreakdownReqResponsiveness", value: 90 },
                        { labelKey: "perfBreakdownInfoCompleteness", value: 70 },
                        { labelKey: "perfBreakdownPublicEngagement", value: 50 }
                    ],
                    activities: [
                        { activity_date: "2023-10-25", title: "Report Release: Annual Budget", status: "Completed" },
                        { activity_date: "2023-11-02", title: "Public Event: Town Hall", status: "In Progress" }
                    ]
                };
            };
            // END: MOCK DATA GENERATORS

            // START: UI UPDATE FUNCTIONS
            function initializeSidebarActiveState() { const sidebarItems = document.querySelectorAll('#sidebar .sidebar-item'); sidebarItems.forEach(item => { item.classList.remove('sidebar-active'); const linkHref = item.getAttribute('href'); if (linkHref) { const linkFilename = linkHref.split('/').pop(); if (linkFilename === currentPageName) { item.classList.add('sidebar-active'); } } }); }
            function updateAllUIText(lang) { document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); const translatedText = getTranslation(key, lang); if (el.tagName === 'TITLE') { document.title = translatedText; } else if (el.tagName === 'INPUT') { const inputType = el.type.toLowerCase(); if (inputType === 'submit' || inputType === 'button' || inputType === 'reset') { el.value = translatedText; } else if (['text', 'search', 'email', 'password', 'tel', 'url', 'number', 'month', 'date', 'time'].includes(inputType)) { el.placeholder = translatedText; } } else if (el.tagName === 'TEXTAREA') { el.placeholder = translatedText; } else if (el.tagName === 'IMG' && key.endsWith('AltText')) { el.alt = translatedText; } else if (el.hasAttribute('data-translate-tooltip') || el.tagName === 'ABBR') { el.title = translatedText; } else { let isSimpleTextOnlyElement = true; if (el.childNodes.length > 0) { for (let i = 0; i < el.childNodes.length; i++) { if (el.childNodes[i].nodeType === Node.ELEMENT_NODE) { if (!['I', 'B', 'STRONG', 'EM', 'BR'].includes(el.childNodes[i].tagName) || el.childNodes[i].hasAttribute('data-translate')) { isSimpleTextOnlyElement = false; break; } } } } if (isSimpleTextOnlyElement) { el.textContent = translatedText; } else { el.innerHTML = translatedText; } } }); document.querySelectorAll('[data-translate-aria-label]').forEach(el => { const key = el.getAttribute('data-translate-aria-label'); el.setAttribute('aria-label', getTranslation(key, lang)); }); if (currentLanguageSpan) { const langKeyForIndicator = `language${lang.toUpperCase()}`; const fullLangName = getTranslation(langKeyForIndicator, lang); const langCodeMatch = fullLangName.match(/\(([A-Z]{2})\)/); currentLanguageSpan.textContent = langCodeMatch ? langCodeMatch[1] : lang.toUpperCase(); } if (isDashboardPage && typeof updateDynamicTitles === "function") { updateDynamicTitles(lang); } if (isDashboardPage && typeof populateCompareWithDropdown === "function" && allMinistriesData && allMinistriesData.length > 0) { populateCompareWithDropdown(allMinistriesData, document.getElementById('compareWithFilter')?.value); } }
            function updateDynamicTitles(lang = currentLang) { if (!isDashboardPage) return; if (currentViewTitle) { const pillarName = getTranslation(`tab${capitalizeFirstLetter(currentPillar)}`, lang); currentViewTitle.textContent = `${pillarName} ${getTranslation('viewTitleSuffix', lang)}`; } if (ministryBarChart?.options?.plugins?.tooltip) { ministryBarChart.data.datasets[0].label = `${getTranslation(`tab${capitalizeFirstLetter(currentPillar)}`, currentLang)} ${getTranslation('tooltipScoreSuffix', currentLang)}`; if (ministryBarChart.ctx && ministryBarChart.attached !== false) { ministryBarChart.update('none'); } } }
            // END: UI UPDATE FUNCTIONS

            // START: Dashboard Specific Functions
            function updateKPICards(summary) { if (!isDashboardPage || !kpiElements.avgTransparencyValue) return; const kpiMap = { avgTransparency: { valueEl: kpiElements.avgTransparencyValue, changeEl: kpiElements.avgTransparencyChange, dataKey: 'avgTransparency' }, participationScore: { valueEl: kpiElements.participationScoreValue, changeEl: kpiElements.participationScoreChange, dataKey: 'participationScore' }, efficiencyRating: { valueEl: kpiElements.efficiencyRatingValue, changeEl: kpiElements.efficiencyRatingChange, dataKey: 'efficiencyRating' }, overallOutcome: { valueEl: kpiElements.overallOutcomeValue, changeEl: kpiElements.overallOutcomeChange, dataKey: 'overallOutcome' } }; for (const key in kpiMap) { const item = kpiMap[key]; if (item.valueEl) { const data = summary?.[item.dataKey]; item.valueEl.textContent = (data?.value !== null && data?.value !== undefined && !isNaN(parseFloat(data.value))) ? `${parseFloat(data.value).toFixed(1)}%` : 'N/A'; if (item.changeEl) { item.changeEl.innerHTML = ''; let iconClass = 'fas fa-minus text-gray-500'; let textColor = 'text-gray-500'; let textContent = getTranslation('noChangeData'); if (data?.change !== null && data?.change !== undefined && !isNaN(parseFloat(data.change))) { const changeValue = parseFloat(data.change); if (changeValue > 0) { iconClass = 'fas fa-arrow-up text-green-500'; textColor = 'text-green-500'; } else if (changeValue < 0) { iconClass = 'fas fa-arrow-down text-red-500'; textColor = 'text-red-500'; } textContent = `${Math.abs(changeValue).toFixed(1)}% ${getTranslation('kpiChangeSinceLastQuarter')}`; } const iconElement = document.createElement('i'); iconElement.className = `${iconClass} mr-1`; const textElement = document.createElement('span'); textElement.className = textColor; textElement.textContent = textContent; item.changeEl.appendChild(iconElement); item.changeEl.appendChild(textElement); } } } }
            function populateMinistryDetails(detailsData) { if (!isDashboardPage || !ministryDetailsSection || !detailElements.transparencyScore) return; if (!detailsData || !detailsData.profile) { ministryDetailsSection.classList.add('hidden'); if(selectedMinistryNameTitle) selectedMinistryNameTitle.textContent = getTranslation('detailsTitle'); if(detailElements.transparencyScore) detailElements.transparencyScore.textContent = 'N/A'; if(detailElements.transparencyChange) { detailElements.transparencyChange.textContent = getTranslation('noChangeData'); detailElements.transparencyChange.className = 'text-xs text-gray-500'; } if(detailElements.requests) detailElements.requests.textContent = 'N/A'; if(detailElements.requestsProcessed) detailElements.requestsProcessed.innerHTML = 'N/A'; if(detailElements.responseTime) detailElements.responseTime.innerHTML = 'N/A'; if(detailElements.responseTimeChange) { detailElements.responseTimeChange.textContent = getTranslation('noChangeData'); detailElements.responseTimeChange.className = 'text-xs text-gray-500'; } for (let i = 1; i <= 5; i++) { if (perfBreakdownElements[`label${i}`]) { perfBreakdownElements[`label${i}`].textContent = getTranslation(`perfBreakdownDefaultLabel${i}`); if(perfBreakdownElements[`value${i}`]) perfBreakdownElements[`value${i}`].textContent = `0%`; if(perfBreakdownElements[`bar${i}`]) perfBreakdownElements[`bar${i}`].style.width = `0%`; } } if (detailElements.recentActivitiesBody) detailElements.recentActivitiesBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${getTranslation('tableNoRecentActivities')}</td></tr>`; return; } const { profile, kpis, performanceBreakdown, activities } = detailsData; if (selectedMinistryNameTitle && profile) { selectedMinistryNameTitle.textContent = profile.name || getTranslation('detailsTitle'); if (profile.id !== undefined) ministryDetailsSection.dataset.currentMinistryId = profile.id; } if (kpis) { if (detailElements.transparencyScore && kpis.transparencyScore) { detailElements.transparencyScore.textContent = (kpis.transparencyScore.value !== null && !isNaN(parseFloat(kpis.transparencyScore.value))) ? `${parseFloat(kpis.transparencyScore.value).toFixed(1)}%` : 'N/A'; if (detailElements.transparencyChange) { if (kpis.transparencyScore.change !== null && !isNaN(parseFloat(kpis.transparencyScore.change))) { const chg = parseFloat(kpis.transparencyScore.change); const pfx = chg === 0 ? '' : (chg > 0 ? '↑ +' : '↓ '); detailElements.transparencyChange.textContent = `${pfx}${Math.abs(chg).toFixed(1)}% ${getTranslation('detailsChangeSinceLastPeriod')}`; detailElements.transparencyChange.className = chg === 0 ? 'text-xs text-gray-500' : (chg > 0 ? 'text-xs text-green-500' : 'text-xs text-red-500'); } else { detailElements.transparencyChange.textContent = getTranslation('noChangeData'); detailElements.transparencyChange.className = 'text-xs text-gray-500'; } } } if (detailElements.requests && detailElements.requestsProcessed && kpis.infoRequests) { detailElements.requests.textContent = (kpis.infoRequests.received !== null && !isNaN(parseFloat(kpis.infoRequests.received))) ? parseFloat(kpis.infoRequests.received).toFixed(0) : 'N/A'; if (kpis.infoRequests.processed !== null && kpis.infoRequests.received !== null) { const receivedNum = parseFloat(kpis.infoRequests.received); const processedNum = parseFloat(kpis.infoRequests.processed); let subText = 'N/A'; if (!isNaN(receivedNum) && !isNaN(processedNum)) { let percStr = ''; if (typeof kpis.infoRequests.percentage_processed === 'number') { percStr = ` (${parseFloat(kpis.infoRequests.percentage_processed).toFixed(1)}%)`; } else if (receivedNum > 0) { const perc = (processedNum / receivedNum) * 100; percStr = ` (${perc.toFixed(1)}%)`; } else if (processedNum === 0 && receivedNum === 0) { percStr = ` (0.0%)`; } else { percStr = ` (N/A%)`; } const icon = `<svg class="w-4 h-4 text-green-500 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`; subText = icon + `${processedNum.toFixed(0)} ${getTranslation('infoRequestsProcessed')}${percStr}`; } detailElements.requestsProcessed.innerHTML = subText; } else { detailElements.requestsProcessed.innerHTML = 'N/A'; } } if (detailElements.responseTime && detailElements.responseTimeChange && kpis.responseTime) { const unit = getTranslation(kpis.responseTime.unit || 'daysUnit'); detailElements.responseTime.innerHTML = (kpis.responseTime.value !== null && !isNaN(parseFloat(kpis.responseTime.value))) ? `${parseFloat(kpis.responseTime.value).toFixed(1)} <span class="text-base font-normal text-gray-500">${unit}</span>` : 'N/A'; if (kpis.responseTime.change !== null && !isNaN(parseFloat(kpis.responseTime.change))) { const changeNum = parseFloat(kpis.responseTime.change); const pfx = changeNum === 0 ? '' : (changeNum > 0 ? '↑ +' : '↓ '); detailElements.responseTimeChange.textContent = `${pfx}${Math.abs(changeNum).toFixed(1)} ${unit} ${getTranslation('detailsChangeSinceLastPeriod')}`; detailElements.responseTimeChange.className = changeNum === 0 ? 'text-xs text-gray-500' : (changeNum > 0 ? 'text-xs text-red-500' : 'text-xs text-green-500'); } else { detailElements.responseTimeChange.textContent = getTranslation('noChangeData'); detailElements.responseTimeChange.className = 'text-xs text-gray-500'; } } } if (performanceBreakdown && Array.isArray(performanceBreakdown)) { for (let i = 0; i < 5; i++) { const item = performanceBreakdown[i]; if (perfBreakdownElements[`label${i+1}`]) { if (item?.labelKey) { perfBreakdownElements[`label${i+1}`].textContent = getTranslation(item.labelKey); const itemValue = (item.value !== null && !isNaN(parseFloat(item.value))) ? parseFloat(item.value).toFixed(0) : 0; if(perfBreakdownElements[`value${i+1}`]) perfBreakdownElements[`value${i+1}`].textContent = `${itemValue}%`; if(perfBreakdownElements[`bar${i+1}`]) perfBreakdownElements[`bar${i+1}`].style.width = `${itemValue}%`; } else { perfBreakdownElements[`label${i+1}`].textContent = getTranslation(`perfBreakdownDefaultLabel${i+1}`); if(perfBreakdownElements[`value${i+1}`]) perfBreakdownElements[`value${i+1}`].textContent = `0%`; if(perfBreakdownElements[`bar${i+1}`]) perfBreakdownElements[`bar${i+1}`].style.width = `0%`; } } } } const acts = activities || detailsData.recentActivities; if (detailElements.recentActivitiesBody) { detailElements.recentActivitiesBody.innerHTML = ''; if (acts && Array.isArray(acts) && acts.length > 0) { acts.forEach(act => { const row = detailElements.recentActivitiesBody.insertRow(); row.insertCell().textContent = (act && act.activity_date) ? act.activity_date : 'N/A'; let originalTitle = (act && act.title) ? act.title : 'N/A'; let titleText = originalTitle; const knownPrefixes = [ { key: 'activityPrefixPublicEvent', original: 'Public Event: '}, { key: 'activityPrefixReportRelease', original: 'Report Release: '}, { key: 'activityPrefixNewInitiative', original: 'New Initiative: '}, { key: 'activityPrefixConsultationDocument', original: 'Consultation Document: '} ]; for (const prefix of knownPrefixes) { if (originalTitle.startsWith(getTranslation(prefix.key, 'en')) || originalTitle.startsWith(prefix.original)) { const actualPrefix = getTranslation(prefix.key, currentLang); const titleWithoutPrefix = originalTitle.substring( (originalTitle.startsWith(getTranslation(prefix.key, 'en')) ? getTranslation(prefix.key, 'en') : prefix.original).length ); titleText = actualPrefix + titleWithoutPrefix; break; } } row.insertCell().textContent = titleText; const statusCell = row.insertCell(); const statusSpan = document.createElement('span'); let statusTextKey = (act && act.status && act.status.toLowerCase() === getTranslation('tableStatusInProgress', 'en').toLowerCase()) ? 'tableStatusInProgress' : 'tableStatusCompleted'; statusSpan.textContent = getTranslation(statusTextKey, currentLang); statusSpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusTextKey === 'tableStatusInProgress' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`; statusCell.appendChild(statusSpan); }); } else { const row = detailElements.recentActivitiesBody.insertRow(); const cell = row.insertCell(); cell.colSpan = 3; cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center'; cell.textContent = getTranslation('tableNoRecentActivities'); } } ministryDetailsSection.classList.remove('hidden'); }
            function renderChart(data) { if (!isDashboardPage || !chartContainer) return; chartContainer.innerHTML = ''; if (!data || !data.length) { chartContainer.innerHTML = `<p class="text-center p-4 text-gray-500">${getTranslation('tableNoDataToDisplay')}</p>`; if (ministryBarChart) { ministryBarChart.destroy(); ministryBarChart = null; } return; } const canvas = document.createElement('canvas'); canvas.id = 'ministryScoreChart'; const baseHeight = 50; const itemHeight = 30; const maxHeight = 700; const minHeight = 300; canvas.height = Math.min(maxHeight, Math.max(minHeight, (data.length * itemHeight) + baseHeight)); chartContainer.appendChild(canvas); const ctx = canvas.getContext('2d'); if (!ctx) { console.error("SCRIPT.JS: renderChart: Failed to get 2D context for canvas!"); return; } const labels = data.map(m => m.name); const scores = data.map(m => m.score); const HIGH_SCORE_THRESHOLD = 70; const MEDIUM_SCORE_THRESHOLD = 40; const COLOR_HIGH_BG = 'rgba(75,192,192,0.7)'; const COLOR_HIGH_BD = 'rgba(75,192,192,1)'; const COLOR_MEDIUM_BG = 'rgba(255,206,86,0.7)'; const COLOR_MEDIUM_BD = 'rgba(255,206,86,1)'; const COLOR_LOW_RED_BG = 'rgba(255, 99, 132, 0.7)'; const COLOR_LOW_RED_BD = 'rgba(255, 99, 132, 1)'; const COLOR_NA_BG = 'rgba(200,200,200,0.7)'; const COLOR_NA_BD = 'rgba(200,200,200,1)'; const bgColors = scores.map(s => { const val = parseFloat(s); if (s === null || s === undefined || isNaN(val)) return COLOR_NA_BG; if (val >= HIGH_SCORE_THRESHOLD) return COLOR_HIGH_BG; if (val >= MEDIUM_SCORE_THRESHOLD) return COLOR_MEDIUM_BG; return COLOR_LOW_RED_BG; }); const bdColors = scores.map(s => { const val = parseFloat(s); if (s === null || s === undefined || isNaN(val)) return COLOR_NA_BD; if (val >= HIGH_SCORE_THRESHOLD) return COLOR_HIGH_BD; if (val >= MEDIUM_SCORE_THRESHOLD) return COLOR_MEDIUM_BD; return COLOR_LOW_RED_BD; }); if (ministryBarChart) { ministryBarChart.destroy(); ministryBarChart = null; } try { ministryBarChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: `${getTranslation(`tab${capitalizeFirstLetter(currentPillar)}`, currentLang)} ${getTranslation('tooltipScoreSuffix', currentLang)}`, data: scores, backgroundColor: bgColors, borderColor: bdColors, borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true,max: 100,title: { display: true, text: getTranslation('tooltipScoreSuffix') }}, y: { ticks: { autoSkip: false, font: { size: window.innerWidth < 480 ? 9 : (window.innerWidth < 768 ? 11 : 13) }, callback: function(value, index, ticks) { const label = this.getLabelForValue(value); let maxLength = 100; if (window.innerWidth < 480) { maxLength = 15; } else if (window.innerWidth < 768) { maxLength = 25; } if (label.length > maxLength) { return label.substring(0, maxLength - 3) + '...'; } return label; } } } }, onClick: (evt, elems) => { if (elems && elems.length > 0) { const item = data[elems[0].index]; if (item && typeof item.id !== 'undefined') { if (ministryDetailsSection) { ministryDetailsSection.classList.remove('hidden'); ministryDetailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); } const period = document.getElementById('timePeriod')?.value || 'q2-2023'; if (typeof loadAndRenderMinistryDetails === "function") loadAndRenderMinistryDetails(item.id, period); } } }, plugins: { legend: {display: false}, tooltip: { enabled: true, callbacks: { title: (items) => data[items[0].dataIndex].name || '', label: (ctx) => `${ctx.dataset.label || ''}: ${ctx.parsed.x?.toFixed(1) ?? 'N/A'}`, afterBody: (items) => { const m = data[items[0].dataIndex]; let dets = []; if (m?.category_key) dets.push(`${getTranslation('categoryLabel', currentLang)}: ${getTranslation(`category${capitalizeFirstLetter(m.category_key)}`, currentLang, capitalizeFirstLetter(m.category_key))}`); if (m?.minister_name) dets.push(`${getTranslation('ministerLabel', currentLang)}: ${m.minister_name}`); if (m?.cabinet_members?.length) { dets.push(''); dets.push(`${getTranslation('tooltipKeyMembers', currentLang)}:`); m.cabinet_members.forEach(mem => { if (mem?.trim()) dets.push(`- ${mem}`); });} dets.push(''); dets.push(`(${getTranslation('tooltipClickForDetails', currentLang)})`); return dets;} } }, datalabels: { display: true, anchor: 'end', align: 'right', offset: -5, color: '#374151', font: { weight: 'bold', size: 10, }, formatter: function(value) {return (value !== null && value !== undefined && !isNaN(parseFloat(value))) ? parseFloat(value).toFixed(1) : getTranslation('dataNotAvailable', currentLang, 'N/A');} } } } }); } catch (e) { console.error("SCRIPT.JS: Chart instantiation ERROR:", e); } }
            function applyFiltersAndSort() { if (!isDashboardPage) return; if (typeof allMinistriesData === 'undefined' || !allMinistriesData) { if (typeof renderChart === "function") renderChart([]); return; } let fData = [...allMinistriesData]; let pmoItem = null; const PMO_ID = 0; const pmoIndexInFData = fData.findIndex(m => m.id === PMO_ID); if (pmoIndexInFData > -1) pmoItem = fData.splice(pmoIndexInFData, 1)[0]; const searchTerm = document.getElementById('searchMinistryInput')?.value.toLowerCase() || ''; if (searchTerm) fData = fData.filter(m => (m.name || '').toLowerCase().includes(searchTerm)); const ministryType = document.getElementById('ministryTypeFilter')?.value || 'all'; if (ministryType !== 'all') fData = fData.filter(m => m.category_key === ministryType); const minScoreInput = document.getElementById('minScoreFilter')?.value; const maxScoreInput = document.getElementById('maxScoreFilter')?.value; const minScore = (minScoreInput !== "" && !isNaN(parseFloat(minScoreInput))) ? parseFloat(minScoreInput) : 0; const maxScore = (maxScoreInput !== "" && !isNaN(parseFloat(maxScoreInput))) ? parseFloat(maxScoreInput) : 100; fData = fData.filter(m => { const score = m.score; if (score === null || score === undefined || isNaN(parseFloat(score))) return false; return parseFloat(score) >= minScore && parseFloat(score) <= maxScore; }); switch (currentSortGlobal) { case 'score-desc': fData.sort((a, b) => (b.score ?? -1) - (a.score ?? -1)); break; case 'score-asc': fData.sort((a, b) => (a.score ?? Infinity) - (b.score ?? Infinity)); break; case 'name-asc': fData.sort((a, b) => (a.name || '').localeCompare(b.name || '')); break; case 'name-desc': fData.sort((a, b) => (b.name || '').localeCompare(a.name || '')); break; default: fData.sort((a, b) => (b.score ?? -1) - (a.score ?? -1)); } if (pmoItem) { let pmoVisible = true; if (searchTerm && !(pmoItem.name || '').toLowerCase().includes(searchTerm)) pmoVisible = false; if (ministryType !== 'all' && pmoItem.category_key !== ministryType) pmoVisible = false; const pmoScoreVal = pmoItem.score; if (pmoScoreVal === null || pmoScoreVal === undefined || isNaN(parseFloat(pmoScoreVal))) { if (!(minScore === 0 && maxScore === 100)) pmoVisible = false; } else if (!(parseFloat(pmoScoreVal) >= minScore && parseFloat(pmoScoreVal) <= maxScore)) pmoVisible = false; if (pmoVisible) fData.unshift(pmoItem); } if (typeof renderChart === "function") renderChart(fData); }
            function populateCompareWithDropdown(ministries, selectedValue) { if (!isDashboardPage) return; const compareWithSel = document.getElementById('compareWithFilter'); if (!compareWithSel) return; const currentSelection = selectedValue || compareWithSel.value; let optionsHtml = `<option value="none" data-translate="optionNoComparison">${getTranslation('optionNoComparison')}</option>`; optionsHtml += `<option value="q1-2023" data-translate="periodQ1_2023_compare">${getTranslation('periodQ1_2023_compare')}</option>`; optionsHtml += `<option value="q4-2022" data-translate="periodQ4_2022_compare">${getTranslation('periodQ4_2022_compare')}</option>`; optionsHtml += `<option value="q2-2022" data-translate="periodQ2_2022_yoy">${getTranslation('periodQ2_2022_yoy')}</option>`; optionsHtml += `<option value="annual-2022" data-translate="periodAnnual_2022_compare">${getTranslation('periodAnnual_2022_compare')}</option>`; compareWithSel.innerHTML = optionsHtml; if (currentSelection && Array.from(compareWithSel.options).some(opt => opt.value === currentSelection)) { compareWithSel.value = currentSelection; } else { compareWithSel.value = "none"; } }
            
            // *** MODIFIED: LOAD MINISTRY DETAILS WITH MOCK DATA ***
            async function loadAndRenderMinistryDetails(id, period) {
                if (!isDashboardPage) return;
                showLoadingIndicator(true);
                // Try to use cache or fetch, fallback to Mock
                try {
                     // Since we know backend is down, skip fetch and use Mock immediately
                     const mockDetails = generateMockMinistryDetails(id, period);
                     populateMinistryDetails(mockDetails);
                } catch(e){
                    console.error('Ministry details fetch/processing error:', e);
                    populateMinistryDetails(null);
                } finally {
                    showLoadingIndicator(false);
                }
            }

            // *** MODIFIED: FETCH DASHBOARD DATA WITH MOCK DATA ***
            async function fetchDashboardData(pillar, lang, period) {
                if (!isDashboardPage) {
                    if(typeof showLoadingIndicator === "function") showLoadingIndicator(false);
                    return;
                }
                console.log(`SCRIPT.JS: fetchDashboardData called. Pillar: ${pillar}, Lang: ${lang}, Period: ${period}`);
                if(typeof showLoadingIndicator === "function") showLoadingIndicator(true);
                
                if(ministryDetailsSection) ministryDetailsSection.classList.add('hidden');

                // Skip actual fetch and use Mock Data
                try {
                    console.log("SCRIPT.JS: Generating MOCK DATA for dashboard.");
                    const data = generateMockDashboardData(pillar);
                    
                    allMinistriesData = data.ministries || [];
                    if(typeof updateKPICards === "function") updateKPICards(data.kpi_summary);
                    
                    if (typeof applyFiltersAndSort === "function") applyFiltersAndSort();
                    if (typeof populateCompareWithDropdown === "function" && allMinistriesData) {
                        populateCompareWithDropdown(allMinistriesData, document.getElementById('compareWithFilter')?.value);
                    }
                } catch(e){
                    console.error('SCRIPT.JS: Dashboard API processing error:', e);
                    if(chartContainer) chartContainer.innerHTML = `<p class="text-red-500 text-center p-4">${getTranslation('errorFetchingData')}</p>`;
                    if(typeof updateKPICards === "function") updateKPICards(null);
                } finally {
                    if(typeof showLoadingIndicator === "function") showLoadingIndicator(false);
                }
            }
            // END: Dashboard Specific Functions

            // START: Local Government Page Specific Functions
            function populateFullMunicipalityDetails(muniFullData) { if (!isLocalGovPage || !municipalityDetailsPanel || !muniFullData) { console.warn("SCRIPT.JS: Missing elements or data for full municipality details panel."); if (municipalityDetailsPanel) municipalityDetailsPanel.classList.add('hidden'); return; } const muniName = selectedMunicipalityDataGlobal?.name || getTranslation('municipalityDetailsTitle'); if (municipalityDetailsNameEl) { municipalityDetailsNameEl.textContent = muniName; } const detailedKPIs = muniFullData.detailed_kpis || {}; if (municipalityDetailTransparencyEl && detailedKPIs.transparencyScore) { municipalityDetailTransparencyEl.textContent = (detailedKPIs.transparencyScore.value !== null && !isNaN(parseFloat(detailedKPIs.transparencyScore.value))) ? `${parseFloat(detailedKPIs.transparencyScore.value).toFixed(1)}%` : getTranslation('dataNotAvailable'); if (municipalityDetailTransparencyChangeEl) { if (detailedKPIs.transparencyScore.change !== null && !isNaN(parseFloat(detailedKPIs.transparencyScore.change))) { const chg = parseFloat(detailedKPIs.transparencyScore.change); const pfx = chg === 0 ? '' : (chg > 0 ? '↑&nbsp;+' : '↓&nbsp;'); municipalityDetailTransparencyChangeEl.innerHTML = `<i class="fas ${chg === 0 ? 'fa-minus' : (chg > 0 ? 'fa-arrow-up' : 'fa-arrow-down')} mr-1"></i>${pfx}${Math.abs(chg).toFixed(1)}% ${getTranslation('detailsChangeSinceLastPeriod')}`; municipalityDetailTransparencyChangeEl.className = `text-sm mt-1 flex items-center ${chg === 0 ? 'text-gray-600' : (chg > 0 ? 'text-green-500' : 'text-red-500')}`; } else { municipalityDetailTransparencyChangeEl.innerHTML = `<i class="fas fa-minus mr-1"></i>${getTranslation('noChangeData')}`; municipalityDetailTransparencyChangeEl.className = 'text-sm text-gray-600 mt-1 flex items-center'; } } } else if (municipalityDetailTransparencyEl) { municipalityDetailTransparencyEl.textContent = getTranslation('dataNotAvailable'); if(municipalityDetailTransparencyChangeEl) municipalityDetailTransparencyChangeEl.innerHTML = `<i class="fas fa-minus mr-1"></i>${getTranslation('noChangeData')}`; } if (municipalityDetailRequestsEl && municipalityDetailRequestsProcessedEl && detailedKPIs.infoRequests) { municipalityDetailRequestsEl.textContent = (detailedKPIs.infoRequests.received !== null && !isNaN(detailedKPIs.infoRequests.received)) ? detailedKPIs.infoRequests.received.toFixed(0) : getTranslation('dataNotAvailable'); const processed = detailedKPIs.infoRequests.processed; const percProcessed = detailedKPIs.infoRequests.percentage_processed; let processedText = getTranslation('dataNotAvailable'); if (processed !== null && !isNaN(processed) && percProcessed !== null && !isNaN(percProcessed)) { const icon = `<svg class="w-4 h-4 text-green-500 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`; processedText = `${icon} ${processed.toFixed(0)} ${getTranslation('infoRequestsProcessed')} (${percProcessed.toFixed(1)}%)`; } municipalityDetailRequestsProcessedEl.innerHTML = processedText; } else if (municipalityDetailRequestsEl) { municipalityDetailRequestsEl.textContent = getTranslation('dataNotAvailable'); if(municipalityDetailRequestsProcessedEl) municipalityDetailRequestsProcessedEl.innerHTML = getTranslation('dataNotAvailable');} if (municipalityDetailResponseTimeEl && municipalityDetailResponseTimeChangeEl && detailedKPIs.responseTime) { const unit = getTranslation(detailedKPIs.responseTime.unit || 'daysUnit'); municipalityDetailResponseTimeEl.innerHTML = (detailedKPIs.responseTime.value !== null && !isNaN(detailedKPIs.responseTime.value)) ? `${parseFloat(detailedKPIs.responseTime.value).toFixed(1)} <span class="text-base font-normal text-gray-500">${unit}</span>` : getTranslation('dataNotAvailable'); if (detailedKPIs.responseTime.change !== null && !isNaN(parseFloat(detailedKPIs.responseTime.change))) { const changeNum = parseFloat(detailedKPIs.responseTime.change); const pfx = changeNum === 0 ? '' : (changeNum > 0 ? '↑&nbsp;+' : '↓&nbsp;'); municipalityDetailResponseTimeChangeEl.innerHTML = `<i class="fas ${changeNum === 0 ? 'fa-minus' : (changeNum > 0 ? 'fa-arrow-up' : 'fa-arrow-down')} mr-1"></i>${pfx}${Math.abs(changeNum).toFixed(1)} ${unit} ${getTranslation('detailsChangeSinceLastPeriod')}`; municipalityDetailResponseTimeChangeEl.className = `text-sm mt-1 flex items-center ${changeNum === 0 ? 'text-gray-600' : (changeNum > 0 ? 'text-red-500' : 'text-green-500')}`; } else { municipalityDetailResponseTimeChangeEl.innerHTML = `<i class="fas fa-minus mr-1"></i>${getTranslation('noChangeData')}`; municipalityDetailResponseTimeChangeEl.className = 'text-sm text-gray-600 mt-1 flex items-center'; } } else if (municipalityDetailResponseTimeEl) { municipalityDetailResponseTimeEl.innerHTML = getTranslation('dataNotAvailable'); if(municipalityDetailResponseTimeChangeEl) municipalityDetailResponseTimeChangeEl.innerHTML = `<i class="fas fa-minus mr-1"></i>${getTranslation('noChangeData')}`; } const perfBreakdownData = muniFullData.detailed_performanceBreakdown || []; for (let i = 0; i < 5; i++) { const item = perfBreakdownData[i]; const labelEl = municipalityPerfBreakdownElements[`label${i+1}`]; const valueEl = municipalityPerfBreakdownElements[`value${i+1}`]; const barEl = municipalityPerfBreakdownElements[`bar${i+1}`]; if (labelEl && valueEl && barEl) { if (item?.labelKey) { labelEl.textContent = getTranslation(item.labelKey); const itemValue = (item.value !== null && !isNaN(parseFloat(item.value))) ? parseFloat(item.value).toFixed(0) : 0; valueEl.textContent = `${itemValue}%`; barEl.style.width = `${itemValue}%`; } else { labelEl.textContent = getTranslation(`perfBreakdownDefaultLabel${i+1}`); valueEl.textContent = `0%`; barEl.style.width = `0%`; } } } const recentActivities = muniFullData.detailed_recentActivities || []; if (municipalityRecentActivitiesBodyEl) { municipalityRecentActivitiesBodyEl.innerHTML = ''; if (recentActivities && recentActivities.length > 0) { recentActivities.forEach(act => { const row = municipalityRecentActivitiesBodyEl.insertRow(); row.insertCell().textContent = act.activity_date || getTranslation('dataNotAvailable'); let originalTitle = act.title || getTranslation('dataNotAvailable'); let titleText = originalTitle; const knownPrefixes = [ { key: 'activityPrefixPublicEvent', originalEN: 'Public Event: '}, { key: 'activityPrefixReportRelease', originalEN: 'Report Release: '}, { key: 'activityPrefixNewInitiative', originalEN: 'New Initiative: '}, { key: 'activityPrefixConsultationDocument', originalEN: 'Consultation Document: '} ]; for (const prefix of knownPrefixes) { if (originalTitle.startsWith(prefix.originalEN)) { const translatedPrefix = getTranslation(prefix.key, currentLang); const titleWithoutPrefix = originalTitle.substring(prefix.originalEN.length); titleText = translatedPrefix + titleWithoutPrefix; break; } } row.insertCell().textContent = titleText; const statusCell = row.insertCell(); const statusSpan = document.createElement('span'); const isCompleted = act.status && act.status.toLowerCase() === getTranslation('tableStatusCompleted', 'en').toLowerCase(); statusSpan.textContent = isCompleted ? getTranslation('tableStatusCompleted') : getTranslation('tableStatusInProgress'); statusSpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isCompleted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`; statusCell.appendChild(statusSpan); }); } else { const row = municipalityRecentActivitiesBodyEl.insertRow(); const cell = row.insertCell(); cell.colSpan = 3; cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center'; cell.textContent = getTranslation('tableNoRecentActivities'); } } municipalityDetailsPanel.classList.remove('hidden'); municipalityDetailsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
            // END: Local Government Page Specific Functions

            // START: initializeKosovoMap Function
            function initializeKosovoMap() { const mapElement = document.getElementById('kosovoMap'); if (!mapElement) { return; } if (typeof L === 'undefined') { console.error("SCRIPT.JS: Leaflet library (L) is not loaded."); return; } delete L.Icon.Default.prototype._getIconUrl; L.Icon.Default.mergeOptions({ iconRetinaUrl: '/static/leaflet/images/marker-icon-2x.png', iconUrl: '/static/leaflet/images/marker-icon.png', shadowUrl: '/static/leaflet/images/marker-shadow.png', }); if (kosovoMapInstance) { kosovoMapInstance.remove(); kosovoMapInstance = null; } console.log("SCRIPT.JS: Initializing Kosovo Map for Local Government page..."); const mapCenter = [42.6026, 20.9030]; kosovoMapInstance = L.map('kosovoMap').setView(mapCenter, 8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', maxZoom: 18, }).addTo(kosovoMapInstance); const getRandomValue = (min, max, decimals = 0) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals)); const getRandomDate = (startYear = 2023, endYear = 2024) => { const year = getRandomValue(startYear, endYear); const month = getRandomValue(1, 12); const day = getRandomValue(1, 28); return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`; }; const activityPrefixesEN = ["Report Release: ", "New Initiative: ", "Public Event: ", "Consultation Document: "]; const generateMockDetailedData = (muniName, baseScore) => { const kpis = { transparencyScore: { value: parseFloat(baseScore) + getRandomValue(-5, 5, 1), change: getRandomValue(-3, 3, 1) }, infoRequests: { received: getRandomValue(50, 250), processed: 0, percentage_processed: 0 }, responseTime: { value: getRandomValue(5, 25, 1), unit: 'daysUnit', change: getRandomValue(-2, 2, 1) } }; kpis.infoRequests.processed = getRandomValue(Math.floor(kpis.infoRequests.received * 0.6), kpis.infoRequests.received); kpis.infoRequests.percentage_processed = kpis.infoRequests.received > 0 ? parseFloat(((kpis.infoRequests.processed / kpis.infoRequests.received) * 100).toFixed(1)) : 0; return { detailed_kpis: kpis, detailed_performanceBreakdown: [ { labelKey: "perfBreakdownWebsiteTransparency", value: getRandomValue(40, 95) }, { labelKey: "perfBreakdownDocAccessibility", value: getRandomValue(30, 90) }, { labelKey: "perfBreakdownReqResponsiveness", value: getRandomValue(50, 98) }, { labelKey: "perfBreakdownInfoCompleteness", value: getRandomValue(35, 92) }, { labelKey: "perfBreakdownPublicEngagement", value: getRandomValue(25, 85) } ], detailed_recentActivities: [ { activity_date: getRandomDate(), title: `${activityPrefixesEN[getRandomValue(0,3)]}${muniName} Project Alpha`, status: (Math.random() > 0.3 ? "Completed" : "In Progress") }, { activity_date: getRandomDate(2023,2023), title: `${activityPrefixesEN[getRandomValue(0,3)]}${muniName} Initiative Beta`, status: "Completed" } ] }; }; const municipalities = [ { name: "Prishtinë / Priština", lat: 42.6629, lng: 21.1655, data: { population: "198,897 (2011)", performance: "High", score: 85, mayor: "Përparim Rama", cabinet_members: ["Donjeta Sahatçiu", "Alban Zogaj", "Florian Dushi", "Arbërie Nagavci", "Krenare Sogojeva-Dermaku"], ...generateMockDetailedData("Prishtinë / Priština", 85) } }, { name: "Prizren", lat: 42.2153, lng: 20.7414, data: { population: "177,781 (2011)", performance: "Medium", score: 65, mayor: "Shaqir Totaj", cabinet_members: ["Hanefi Muharremi", "Mevlan Krasniqi", "Manushaqe Koci", "Visar Islamaj", "Pacinda Kelmendi"], ...generateMockDetailedData("Prizren", 65) } }, { name: "Ferizaj / Uroševac", lat: 42.3708, lng: 21.1461, data: { population: "108,610 (2011)", performance: "High", score: 90, mayor: "Agim Aliu", cabinet_members: ["Cabinet F", "Cabinet G", "Cabinet H"], ...generateMockDetailedData("Ferizaj / Uroševac", 90) } }, { name: "Pejë / Peć", lat: 42.6592, lng: 20.2883, data: { population: "96,450 (2011)", performance: "Low", score: 35, mayor: "Gazmend Muhaxheri", cabinet_members: ["Team X", "Team Y", "Team Z", "Team W"], ...generateMockDetailedData("Pejë / Peć", 35) } }, { name: "Gjakovë / Đakovica", lat: 42.3792, lng: 20.4294, data: { population: "94,556 (2011)", performance: "Medium", score: 55, mayor: "Ardian Gjini", cabinet_members: ["Person 1", "Person 2", "Person 3"], ...generateMockDetailedData("Gjakovë / Đakovica", 55) } }, { name: "Gjilan / Gnjilane", lat: 42.4628, lng: 21.4694, data: { population: "90,178 (2011)", performance: "High", score: 78, mayor: "Alban Hyseni", cabinet_members: ["Kabineti A", "Kabineti B", "Kabineti C", "Kabineti D"], ...generateMockDetailedData("Gjilan / Gnjilane", 78) } }, { name: "Mitrovicë / Mitrovica (South)", lat: 42.8914, lng: 20.8660, data: { population: "71,909 (2011, South only)", performance: "Low", score: 40, mayor: "Bedri Hamza", cabinet_members: ["Član A", "Član B", "Član C"], ...generateMockDetailedData("Mitrovicë / Mitrovica (South)", 40) } } ];
        const infoPanel = document.getElementById('municipalityInfoPanel'); const defaultInfoText = getTranslation('mapClickPrompt'); if (infoPanel) infoPanel.innerHTML = `<p class="text-gray-500 text-sm italic">${defaultInfoText}</p>`;
        municipalities.forEach(muni => { if (typeof muni.lat !== 'number' || typeof muni.lng !== 'number') { console.warn(`SCRIPT.JS: Invalid or missing coords for ${muni.name}. Skipping marker.`); return; } let markerColor = 'blue'; let iconHtml = `<i class="fas fa-question-circle" style="color: white; font-size: 14px;"></i>`; if (muni.data && muni.data.performance) { switch (muni.data.performance.toLowerCase()) { case 'high': markerColor = 'green'; iconHtml = `<i class="fas fa-check-circle" style="color: white; font-size: 14px;"></i>`; break; case 'medium': markerColor = '#FFC107'; iconHtml = `<i class="fas fa-exclamation-circle" style="color: white; font-size: 14px;"></i>`; break; case 'low': markerColor = 'red'; iconHtml = `<i class="fas fa-times-circle" style="color: white; font-size: 14px;"></i>`; break; } } const customMarkerIcon = L.divIcon({ html: `<div style="background-color: ${markerColor}; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">${iconHtml}</div>`, className: '', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] }); try { const marker = L.marker([muni.lat, muni.lng], {icon: customMarkerIcon}).addTo(kosovoMapInstance); let tooltipHtml = `<div style="min-width: 180px;">`; tooltipHtml += `<div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${muni.name}</div>`; const mayorName = (muni.data && muni.data.mayor) ? muni.data.mayor : getTranslation('dataNotAvailable'); tooltipHtml += `<div><strong style="color: #333;">${getTranslation('mapMayorLabel')}:</strong> ${mayorName}</div>`; if (muni.data && muni.data.cabinet_members && muni.data.cabinet_members.length > 0) { tooltipHtml += `<div style="margin-top: 5px;"><strong style="color: #333;">${getTranslation('mapCabinetMembersLabel')}:</strong>`; tooltipHtml += `<ul style="list-style-type: none; padding-left: 0; margin-top: 2px; max-height: 70px; overflow-y: auto;">`; muni.data.cabinet_members.slice(0, 5).forEach(member => { tooltipHtml += `<li style="font-size: 0.9em; color: #555;">- ${member}</li>`; }); tooltipHtml += `</ul></div>`; } tooltipHtml += `</div>`; marker.bindTooltip(tooltipHtml, { permanent: false, direction: 'top', opacity: 0.95, offset: L.point(0, -30), className: 'kosovo-map-tooltip leaflet-tooltip-content'}); marker.on('click', function() { selectedMunicipalityDataGlobal = muni; if (infoPanel) { const performanceText = muni.data.performance ? getTranslation('mapPerformance' + capitalizeFirstLetter(muni.data.performance.toLowerCase()), currentLang, muni.data.performance) : getTranslation('dataNotAvailable'); let performanceColor = 'blue'; if(muni.data.performance) { switch(muni.data.performance.toLowerCase()){ case 'high': performanceColor = 'green'; break; case 'medium': performanceColor = '#FFC107'; break; case 'low': performanceColor = 'red'; break; } } infoPanel.innerHTML = ` <h5 class="text-md font-semibold text-gray-800 mb-1">${muni.name}</h5> ${muni.data.mayor ? `<p class="text-sm text-gray-600">${getTranslation('mapMayorLabel')}: ${muni.data.mayor}</p>` : ''} ${muni.data.population ? `<p class="text-sm text-gray-600">${getTranslation('mapPopulation')}: ${muni.data.population}</p>` : ''} <p class="text-sm text-gray-600">${getTranslation('mapPerformance')}: <span style="color:${performanceColor}; font-weight:bold;">${performanceText}</span></p> ${muni.data.score !== undefined ? `<p class="text-sm text-gray-600">${getTranslation('mapScore')}: ${muni.data.score}/100</p>` : ''} ${(muni.data.cabinet_members && muni.data.cabinet_members.length > 0) ? `<div class="mt-2"><p class="text-sm font-medium text-gray-700">${getTranslation('mapCabinetMembersLabel')}:</p><ul class="list-disc list-inside text-xs text-gray-600">${muni.data.cabinet_members.map(m => `<li>${m}</li>`).join('')}</ul></div>` : ''} <a href="#" id="viewMunicipalityMoreDetailsLink" data-municipality-name="${muni.name}" class="text-xs text-blue-600 hover:underline mt-2 inline-block">${getTranslation('mapViewDetails')}</a>`; } }); } catch (markerError) { console.error(`SCRIPT.JS: Error creating/adding marker for ${muni.name}:`, markerError); } });
            console.log("SCRIPT.JS: Kosovo Map initialized with markers.");
        }
        // END: initializeKosovoMap Function

        // START: CORE LOGIC FUNCTIONS
        function setLanguage(lang) { if(lang !== currentLang){ currentLang = lang; localStorage.setItem('preferredLang', lang); updateAllUIText(lang); showNotification(`${getTranslation('notificationLangSwitchPrefix')} ${getTranslation(`language${lang.toUpperCase()}`)}`, false); if (isDashboardPage) { const periodVal = document.getElementById('timePeriod')?.value || 'q2-2023'; if(typeof fetchDashboardData === "function") fetchDashboardData(currentPillar, currentLang, periodVal); if(ministryDetailsSection && !ministryDetailsSection.classList.contains('hidden')){ const mId = ministryDetailsSection.dataset.currentMinistryId; if(mId !== undefined && typeof loadAndRenderMinistryDetails === "function") loadAndRenderMinistryDetails(parseInt(mId), periodVal); } if (ministryBarChart && typeof applyFiltersAndSort === "function") { applyFiltersAndSort(); } } else if (isLocalGovPage) { const previouslySelectedMuniGlobal = selectedMunicipalityDataGlobal; const wasDetailedPanelOpen = municipalityDetailsPanel && !municipalityDetailsPanel.classList.contains('hidden'); if(typeof initializeKosovoMap === "function") { initializeKosovoMap(); } if (previouslySelectedMuniGlobal) { selectedMunicipalityDataGlobal = previouslySelectedMuniGlobal; const infoPanel = document.getElementById('municipalityInfoPanel'); const muni = previouslySelectedMuniGlobal; if (infoPanel) { const performanceText = muni.data.performance ? getTranslation('mapPerformance' + capitalizeFirstLetter(muni.data.performance.toLowerCase()), currentLang, muni.data.performance) : getTranslation('dataNotAvailable'); let performanceColor = 'blue'; if(muni.data.performance) { switch(muni.data.performance.toLowerCase()){ case 'high': performanceColor = 'green'; break; case 'medium': performanceColor = '#FFC107'; break; case 'low': performanceColor = 'red'; break; } } infoPanel.innerHTML = ` <h5 class="text-md font-semibold text-gray-800 mb-1">${muni.name}</h5> ${muni.data.mayor ? `<p class="text-sm text-gray-600">${getTranslation('mapMayorLabel')}: ${muni.data.mayor}</p>` : ''} ${muni.data.population ? `<p class="text-sm text-gray-600">${getTranslation('mapPopulation')}: ${muni.data.population}</p>` : ''} <p class="text-sm text-gray-600">${getTranslation('mapPerformance')}: <span style="color:${performanceColor}; font-weight:bold;">${performanceText}</span></p> ${muni.data.score !== undefined ? `<p class="text-sm text-gray-600">${getTranslation('mapScore')}: ${muni.data.score}/100</p>` : ''} ${(muni.data.cabinet_members && muni.data.cabinet_members.length > 0) ? `<div class="mt-2"><p class="text-sm font-medium text-gray-700">${getTranslation('mapCabinetMembersLabel')}:</p><ul class="list-disc list-inside text-xs text-gray-600">${muni.data.cabinet_members.map(m => `<li>${m}</li>`).join('')}</ul></div>` : ''} <a href="#" id="viewMunicipalityMoreDetailsLink" data-municipality-name="${muni.name}" class="text-xs text-blue-600 hover:underline mt-2 inline-block">${getTranslation('mapViewDetails')}</a>`; } } else { const infoPanel = document.getElementById('municipalityInfoPanel'); if(infoPanel) infoPanel.innerHTML = `<p class="text-gray-500 text-sm italic">${getTranslation('mapClickPrompt')}</p>`; } if (wasDetailedPanelOpen && municipalityDetailsPanel && selectedMunicipalityDataGlobal) { populateFullMunicipalityDetails(selectedMunicipalityDataGlobal.data); } } } }
        function setupEventListeners() { if (languageSelectorButton && languageDropdown) { languageSelectorButton.addEventListener('click', (e) => { e.stopPropagation(); languageDropdown.classList.toggle('hidden'); }); languageDropdown.addEventListener('click', (e) => { const opt = e.target.closest('a[data-lang]'); if (opt) { e.preventDefault(); setLanguage(opt.dataset.lang); languageDropdown.classList.add('hidden'); } }); } const userMenuBtn = document.getElementById('userMenu'); const userDropdownEl = document.getElementById('userDropdown'); if (userMenuBtn && userDropdownEl) { userMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); userDropdownEl.classList.toggle('hidden'); }); } const mobileSidebarToggle = document.getElementById('mobileSidebarToggle'); const sidebar = document.getElementById('sidebar'); const closeSidebarButton = document.getElementById('toggleSidebar'); const overlay = document.getElementById('mobileSidebarOverlay'); function openMobileSidebar() { if (sidebar && overlay) { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); overlay.classList.remove('hidden'); } } function closeMobileSidebar() { if (sidebar && overlay) { sidebar.classList.add('-translate-x-full'); sidebar.classList.remove('translate-x-0'); overlay.classList.add('hidden'); } } if (mobileSidebarToggle && sidebar && overlay) { mobileSidebarToggle.addEventListener('click', (e) => { e.stopPropagation(); if (sidebar.classList.contains('-translate-x-full')) { openMobileSidebar(); } else { closeMobileSidebar(); } }); } if (closeSidebarButton && sidebar && overlay) { closeSidebarButton.addEventListener('click', (e) => { e.stopPropagation(); closeMobileSidebar(); }); } if (overlay) { overlay.addEventListener('click', () => { closeMobileSidebar(); }); } if (sidebar) { sidebar.querySelectorAll('a.sidebar-item').forEach(link => { link.addEventListener('click', () => { if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) { closeMobileSidebar(); } }); }); } document.addEventListener('click', (e) => { if (languageDropdown && !languageDropdown.classList.contains('hidden') && languageSelectorButton && !languageSelectorButton.contains(e.target) && !languageDropdown.contains(e.target)) { languageDropdown.classList.add('hidden'); } if (userDropdownEl && !userDropdownEl.classList.contains('hidden') && userMenuBtn && !userMenuBtn.contains(e.target) && !userDropdownEl.contains(e.target)) { userDropdownEl.classList.add('hidden'); } if(isDashboardPage){ const exportDd = document.getElementById('exportDropdown'); const exportBtn = document.getElementById('exportButton'); if (exportDd && !exportDd.classList.contains('hidden') && exportBtn && !exportBtn.contains(e.target) && !exportDd.contains(e.target)) exportDd.classList.add('hidden'); const sortDd = document.getElementById('sortDropdown'); const sortBtn = document.getElementById('sortButton'); if (sortDd && !sortDd.classList.contains('hidden') && sortBtn && !sortBtn.contains(e.target) && !sortDd.contains(e.target)) sortDd.classList.add('hidden'); } if (isLocalGovPage && e.target && e.target.id === 'viewMunicipalityMoreDetailsLink') { e.preventDefault(); if (selectedMunicipalityDataGlobal && typeof populateFullMunicipalityDetails === "function") { populateFullMunicipalityDetails(selectedMunicipalityDataGlobal.data); } else { console.warn("SCRIPT.JS: No selected municipality data to show details for, or function missing."); } } }); if (isDashboardPage) { const exportBtnEl = document.getElementById('exportButton'); const exportDropdownEl = document.getElementById('exportDropdown'); if (exportBtnEl && exportDropdownEl) { exportBtnEl.addEventListener('click', (e) => { e.stopPropagation(); exportDropdownEl.classList.toggle('hidden'); }); } if (pillarTabs) { pillarTabs.forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); const pillar = tab.dataset.tab; if (pillar && pillar !== currentPillar) { currentPillar = pillar; pillarTabs.forEach(t => {t.classList.remove('tab-active','border-blue-600','text-blue-600'); t.classList.add('text-gray-500','hover:text-gray-700','hover:border-gray-300');}); tab.classList.add('tab-active','border-blue-600','text-blue-600'); tab.classList.remove('text-gray-500','hover:text-gray-700','hover:border-gray-300'); if(typeof updateDynamicTitles === "function") updateDynamicTitles(); const period = document.getElementById('timePeriod')?.value||'q2-2023'; if(typeof fetchDashboardData === "function") fetchDashboardData(currentPillar,currentLang,period); } }); }); } const applyBtn = document.getElementById('applyFiltersButton'); if(applyBtn) { applyBtn.addEventListener('click', () => { if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); showNotification('notificationFiltersApplied',true); }); } const resetFiltersBtn = document.getElementById('resetFiltersButton'); if (resetFiltersBtn) { resetFiltersBtn.addEventListener('click', () => { const timePeriodEl = document.getElementById('timePeriod'); if(timePeriodEl) timePeriodEl.value = 'q2-2023'; const compareWithEl = document.getElementById('compareWithFilter'); if(compareWithEl) compareWithEl.value = 'none'; const ministryTypeEl = document.getElementById('ministryTypeFilter'); if(ministryTypeEl) ministryTypeEl.value = 'all'; const minScoreEl = document.getElementById('minScoreFilter'); if(minScoreEl) minScoreEl.value = 0; const maxScoreEl = document.getElementById('maxScoreFilter'); if(maxScoreEl) maxScoreEl.value = 100; const searchInputEl = document.getElementById('searchMinistryInput'); if(searchInputEl) searchInputEl.value = ''; const showComparisonEl = document.getElementById('showComparisonCheckbox'); if(showComparisonEl) showComparisonEl.checked = false; if (typeof applyFiltersAndSort === "function") applyFiltersAndSort(); showNotification('notificationFiltersReset', true); }); } const searchIn = document.getElementById('searchMinistryInput'); if(searchIn) { searchIn.addEventListener('input', debounce(() => { if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); }, 300)); } const ministryTypeSel = document.getElementById('ministryTypeFilter'); if (ministryTypeSel) { ministryTypeSel.addEventListener('change', () => { if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); });} const compareWithSel = document.getElementById('compareWithFilter'); if (compareWithSel) { compareWithSel.addEventListener('change', () => { if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); }); } const minScoreIn = document.getElementById('minScoreFilter'); const maxScoreIn = document.getElementById('maxScoreFilter'); if (minScoreIn && maxScoreIn) { const h = debounce(() => { if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); }, 500); minScoreIn.addEventListener('input', h); minScoreIn.addEventListener('change', h); maxScoreIn.addEventListener('input', h); maxScoreIn.addEventListener('change', h); } const sortBtn = document.getElementById('sortButton'); const sortDd = document.getElementById('sortDropdown'); if(sortBtn && sortDd){ sortBtn.addEventListener('click', (e) => { e.stopPropagation(); sortDd.classList.toggle('hidden'); }); sortDd.addEventListener('click', (e) => { const opt = e.target.closest('.sortOption[data-sort]'); if(opt){ e.preventDefault(); const sortVal = opt.dataset.sort; if(sortVal){ currentSortGlobal = sortVal; if(typeof applyFiltersAndSort === "function") applyFiltersAndSort(); sortDd.classList.add('hidden'); const parts = currentSortGlobal.split('-'); const key = `sort${capitalizeFirstLetter(parts[0])}${capitalizeFirstLetter(parts[1]||'')}`; showNotification(`${getTranslation('notificationSortedByPrefix')} ${getTranslation(key)}`); } } }); } const closeBtn = document.getElementById('closeMinistryDetailsButton'); if(closeBtn && ministryDetailsSection) { closeBtn.addEventListener('click', () => { ministryDetailsSection.classList.add('hidden'); ministryDetailsSection.removeAttribute('data-current-ministry-id'); if(chartContainer) chartContainer.scrollIntoView({behavior:'smooth',block:'nearest'}); }); } const periodSel = document.getElementById('timePeriod'); if (periodSel) { periodSel.addEventListener('change', () => { const periodValue = periodSel.value; if(typeof fetchDashboardData === "function") fetchDashboardData(currentPillar, currentLang, periodValue); if(ministryDetailsSection && !ministryDetailsSection.classList.contains('hidden')){ const mId = ministryDetailsSection.dataset.currentMinistryId; if(mId !== undefined && typeof loadAndRenderMinistryDetails === "function") loadAndRenderMinistryDetails(parseInt(mId), periodValue); } }); } } if (isLocalGovPage && municipalityCloseDetailsBtn && municipalityDetailsPanel) { municipalityCloseDetailsBtn.addEventListener('click', () => { municipalityDetailsPanel.classList.add('hidden'); }); } }
            // END: CORE LOGIC FUNCTIONS

            // --- SCRIPT INITIALIZATION ---
            const preferredLang = localStorage.getItem('preferredLang'); if (preferredLang && translations[preferredLang]) { currentLang = preferredLang; }
            updateAllUIText(currentLang); initializeSidebarActiveState();
            if(typeof setupEventListeners === "function") { setupEventListeners(); } else { console.error("SCRIPT.JS: setupEventListeners function is not defined!"); }
            if (isDashboardPage) { if(typeof updateDynamicTitles === "function") updateDynamicTitles(currentLang); const initialPeriod = document.getElementById('timePeriod')?.value || 'q2-2023'; if(typeof fetchDashboardData === "function") { fetchDashboardData(currentPillar, currentLang, initialPeriod) .then(() => { console.log("SCRIPT.JS: Dashboard data fetched (MOCK), attempting UI text update FOR DYNAMIC CONTENT."); updateAllUIText(currentLang); }) .catch(error => { console.error("SCRIPT.JS: Dashboard data fetch error during initial load:", error); if (typeof renderChart === "function") renderChart([]); if (typeof updateKPICards === "function") updateKPICards(null); updateAllUIText(currentLang); }) .finally(() => { setTimeout(() => { console.log("SCRIPT.JS: Dashboard page - final UI text update via setTimeout."); updateAllUIText(currentLang); }, 50); }); } else { console.error("SCRIPT.JS: fetchDashboardData function is not defined!"); setTimeout(() => { console.log("SCRIPT.JS: Dashboard page (no fetch) - final UI text update via setTimeout."); updateAllUIText(currentLang); }, 50); }
                // Resize listener for dashboard chart
                window.addEventListener('resize', debounce(() => {
                    if (ministryBarChart && allMinistriesData.length > 0) {
                        console.log("SCRIPT.JS: Window resized, re-rendering chart for dashboard.");
                        applyFiltersAndSort(); // This function calls renderChart
                    }
                }, 250));
            } else if (isLocalGovPage) { if (typeof initializeKosovoMap === "function") { initializeKosovoMap(); } else { console.error("SCRIPT.JS: initializeKosovoMap function is not defined!"); } setTimeout(() => { console.log("SCRIPT.JS: Local Gov page - final UI text update via setTimeout."); updateAllUIText(currentLang); }, 50); } else { setTimeout(() => { console.log(`SCRIPT.JS: Page ${currentPageName} - final UI text update via setTimeout.`); updateAllUIText(currentLang); }, 50); }
            const yearSpan = document.getElementById('currentYear'); if(yearSpan) yearSpan.textContent = new Date().getFullYear().toString();
            console.log(`SCRIPT.JS DOMInit (via initializeAppLogic): Page (${currentPageName}) initialization sequence complete. Initial lang: ${currentLang}.`);
            // END --- SCRIPT INITIALIZATION ---

        } // End of initializeAppLogic function

        // Conditional initialization call
        if (isDashboardPage) {
            if (chartLibrariesLoaded) {
                initializeAppLogic();
            } else {
                console.error("SCRIPT.JS: Chart.js libraries did not load. Dashboard cannot be fully initialized. Attempting minimal setup.");
                let tempLang = localStorage.getItem('preferredLang') || 'en';
                if (typeof translations === 'undefined' || !translations[tempLang]) { tempLang = 'en';}
                if (typeof translations === 'undefined') { console.error("Critical Fallback Error: Main translations object is not defined globally."); return; }
                
                function getTranslationFallback(key, lang = tempLang) { try { let text = translations[lang]?.[key]; if (text === undefined) { text = translations['en']?.[key]; } if (text === undefined) { return key; } return text; } catch(e) {return key;} }
                function initializeSidebarActiveStateFallback() { const sidebarItems = document.querySelectorAll('#sidebar .sidebar-item'); sidebarItems.forEach(item => { item.classList.remove('sidebar-active'); const linkHref = item.getAttribute('href'); if (linkHref) { const linkFilename = linkHref.split('/').pop(); if (linkFilename === getCurrentPageName()) { item.classList.add('sidebar-active'); } } }); }
                function updateAllUITextFallback(lang) { document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); el.textContent = getTranslationFallback(key, lang); }); if (currentLanguageSpan) { const langKeyForIndicator = `language${lang.toUpperCase()}`; const fullLangName = getTranslationFallback(langKeyForIndicator, lang); const langCodeMatch = fullLangName.match(/\(([A-Z]{2})\)/); currentLanguageSpan.textContent = langCodeMatch ? langCodeMatch[1] : lang.toUpperCase(); } }
                
                try {
                    updateAllUITextFallback(tempLang);
                    initializeSidebarActiveStateFallback();
                } catch (e) {
                    console.error("Error in minimal fallback UI update:", e);
                }
                console.log("SCRIPT.JS: Minimal setup for dashboard (due to missing chart libraries) attempted.");
            }
        } else {
            initializeAppLogic();
        }
    }; // End of window.onload listener

    // START: Polyfills
    if (typeof Element !== 'undefined' && !Element.prototype.matches) { Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector; }
    if (typeof Element !== 'undefined' && !Element.prototype.closest) { Element.prototype.closest = function(s) { var el = this; do { if (Element.prototype.matches.call(el, s)) return el; el = el.parentElement || el.parentNode; } while (el !== null && el.nodeType === 1); return null; }; }
    // END: Polyfills

    // START: Final Script Parse Logging
    console.log("MAIN_SCRIPT.JS: End of file reached. Script fully parsed.");
        // END: Final Script Parse Logging
    }